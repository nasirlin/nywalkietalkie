<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NY Walkie-Talkie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        body { background-color: #e9ecef; display: flex; flex-direction: column; min-height: 100vh; align-items: center; justify-content: center; padding: 15px; font-family: 'Segoe UI', Roboto, sans-serif; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        .device-chassis { width: 100%; max-width: 420px; background-color: #212529; border: 4px solid #000; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); padding: 20px; color: #fff; position: relative; }
        .device-chassis::before { content: ''; position: absolute; top: -35px; right: 30px; width: 30px; height: 40px; background: #212529; border: 4px solid #000; border-bottom: none; border-radius: 5px 5px 0 0; z-index: -1; }
        .device-screen { background-color: #f8f9fa; color: #212529; border: 3px solid #495057; border-radius: 6px; padding: 15px; min-height: 600px; display: flex; flex-direction: column; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; margin-bottom: 15px; }
        h1 { font-size: 1.2rem; font-weight: 800; margin: 0; }
        .led-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; background: #e9ecef; padding: 5px; border-radius: 30px; border: 1px solid #ced4da; }
        .led { width: 12px; height: 12px; border-radius: 50%; background-color: #adb5bd; border: 1px solid #6c757d; transition: all 0.2s; }
        .led.red.active { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; animation: blink 0.5s infinite; }
        .led.green.active { background-color: #198754; box-shadow: 0 0 8px #198754; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; }
        .video-card { background: #000; aspect-ratio: 4/3; position: relative; border: 1px solid #333; overflow: hidden; }
        .video-content { width: 100%; height: 100%; object-fit: cover; }
        .video-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.7rem; background: #212529; z-index: 1; }
        .video-label { position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.8); color: #fff; font-size: 0.6rem; padding: 2px 4px; z-index: 2; }
        .camera-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .cam-btn { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; border: 1px solid #6c757d; background: #fff; font-weight: bold; }
        .cam-btn.active { background: #198754; color: white; border-color: #198754; }
        .ptt-container { margin-top: auto; padding-top: 10px; }
        #ptt-button { width: 100%; height: 80px; background: linear-gradient(180deg, #e9ecef 0%, #ced4da 100%); border: 3px solid #495057; border-radius: 8px; color: #212529; font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; box-shadow: 0 5px 0 #6c757d; }
        #ptt-button:active, #ptt-button.active { transform: translateY(4px); box-shadow: 0 0 0 #6c757d; background: #dc3545; color: white; border-color: #842029; }
        #ptt-button:disabled { background: #e9ecef; color: #adb5bd; border-color: #dee2e6; cursor: not-allowed; box-shadow: none; transform: none; }
        .speaker-holes { margin-top: 20px; height: 20px; background-image: radial-gradient(#333 20%, transparent 20%); background-size: 5px 5px; opacity: 0.4; }
        .form-control, .btn { border-radius: 0; font-weight: 700; }
        .btn-primary { background: #000; border: #000; }
        #error-log { font-size: 0.7rem; color: #dc3545; text-align: center; margin-top: 5px; }
        .connection-badge { font-size: 0.65rem; background: #ffc107; color: #000; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: none; }
    </style>
</head>
<body>

<div class="device-chassis">
    <div class="device-screen">
        <div class="top-bar">
            <h1>NY Walkie-Talkie</h1>
            <div id="user-count-display" style="font-weight:bold; font-size:0.8rem; display:none;">ONLINE: 0</div>
        </div>

        <div id="lobby-view">
            <p class="text-center text-muted mt-5">ENTER FREQUENCY CODE</p>
            <div class="mb-3"><input type="text" id="room-code-input" class="form-control text-center" placeholder="12345678" maxlength="8"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" onclick="App.attemptJoin()">CONNECT</button>
                <button class="btn btn-outline-dark" onclick="App.createRoom()">NEW CHANNEL</button>
            </div>
            <div id="error-log"></div>
        </div>

        <div id="room-view" style="display: none; height: 100%; flex-direction: column;">
            <div class="led-container">
                <div style="display:flex; align-items:center;"><div id="led-tx" class="led red"></div><span style="font-size:0.7rem; margin-left:5px; font-weight:bold;">TX</span></div>
                <div style="display:flex; align-items:center;"><div id="led-rx" class="led green"></div><span style="font-size:0.7rem; margin-left:5px; font-weight:bold;">RX</span></div>
            </div>
            <div class="text-center mb-2" style="font-family: monospace; font-size: 0.9rem;">
                FREQ: <strong id="room-id-display">--</strong>
                <span id="p2p-status" class="connection-badge">Wait...</span>
            </div>

            <div class="video-grid" id="video-grid">
                <div class="video-card">
                    <div id="local-video-placeholder" class="video-placeholder">CAM OFF</div>
                    <video id="local-video" class="video-content" style="display:none;" autoplay muted playsinline></video>
                    <div class="video-label">YOU</div>
                </div>
            </div>

            <div class="camera-controls">
                <button id="btn-toggle-cam" class="btn cam-btn" onclick="App.toggleCamera()">ðŸ“· CAM ON</button>
                <button id="btn-switch-cam" class="btn cam-btn" onclick="App.switchCamera()" style="display:none;">ðŸ”„ SWITCH</button>
            </div>

            <div id="status-text" class="text-center mb-2 fw-bold text-muted" style="font-size: 0.8rem;">INITIALIZING...</div>

            <div class="ptt-container">
                <button id="ptt-button" disabled>HOLD TO TALK</button>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-outline-dark btn-sm flex-grow-1" onclick="App.leaveRoom()">LEAVE</button>
                <button id="host-destroy-btn" class="btn btn-danger btn-sm flex-grow-1" style="display:none;" onclick="App.destroyRoom()">DESTROY</button>
            </div>
        </div>
    </div>
    <div class="speaker-holes"></div>
</div>
<div style="margin-top:20px; font-size:0.8rem; font-weight:bold; color:#6c757d;">COPYRIGHT 2025 NASIR</div>

<script>
    const CONFIG = {
        SERVER_URL: "https://nywalkietalkie.onrender.com",
        ICE_SERVERS: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
    };

    const App = {
        socket: null,
        localStream: null,
        peers: {},
        
        isTalking: false, isChannelBusy: false, isCameraOn: false, currentFacingMode: 'environment',

        // Elements
        pttBtn: document.getElementById('ptt-button'),
        localVideo: document.getElementById('local-video'),
        videoPlaceholder: document.getElementById('local-video-placeholder'),
        videoGrid: document.getElementById('video-grid'),
        statusText: document.getElementById('status-text'),
        ledTx: document.getElementById('led-tx'), ledRx: document.getElementById('led-rx'),
        errorLog: document.getElementById('error-log'),
        p2pStatus: document.getElementById('p2p-status'),

        init: function() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                return alert("å¿…é ˆä½¿ç”¨ HTTPSï¼");
            }
            this.socket = io(CONFIG.SERVER_URL);
            this.bindSocketEvents();
            this.checkAutoLogin();
            this.bindPTTLogic();
        },

        attemptJoin: async function() {
            const code = document.getElementById('room-code-input').value.trim();
            if (code.length !== 8) return alert('è«‹è¼¸å…¥ 8 ä½æ•¸ä»£ç¢¼');

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                await ctx.resume();

                this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                this.localStream.getAudioTracks()[0].enabled = false;

                this.socket.emit('join_room', { roomId: code, token: localStorage.getItem('ny_host_token') });

            } catch (err) {
                alert("éº¥å…‹é¢¨å­˜å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚");
                console.error(err);
            }
        },

        initPeer: function(targetID) {
            const peer = new RTCPeerConnection(CONFIG.ICE_SERVERS);
            
            if (this.localStream) {
                this.localStream.getTracks().forEach(track => peer.addTrack(track, this.localStream));
            }
            peer.addTransceiver('video', { direction: 'sendrecv' });

            peer.onicecandidate = (e) => {
                if (e.candidate) {
                    this.socket.emit('sending_signal', {
                        userToSignal: targetID, callerID: this.socket.id,
                        signal: { type: 'candidate', candidate: e.candidate }
                    });
                }
            };

            peer.ontrack = (e) => this.handleRemoteStream(targetID, e.streams[0]);

            peer.onconnectionstatechange = () => {
                console.log(`Connection to ${targetID}: ${peer.connectionState}`);
                if (peer.connectionState === 'connected') {
                    this.p2pStatus.innerText = "P2P Connected";
                    this.p2pStatus.style.background = "#198754";
                    this.p2pStatus.style.color = "#fff";
                }
            };

            this.peers[targetID] = { conn: peer, candidateQueue: [] };
            return peer;
        },

        callPeer: function(targetID) {
            const peer = this.initPeer(targetID);
            peer.createOffer().then(offer => {
                peer.setLocalDescription(offer);
                this.socket.emit('sending_signal', {
                    userToSignal: targetID, callerID: this.socket.id,
                    signal: { type: 'sdp', sdp: offer }
                });
            });
        },

        handleSignal: function(payload) {
            const { signal, callerID } = payload;
            
            if (!this.peers[callerID]) {
                this.initPeer(callerID);
            }

            const item = this.peers[callerID];
            const peer = item.conn;

            if (signal.type === 'sdp') {
                peer.setRemoteDescription(new RTCSessionDescription(signal.sdp)).then(() => {
                    if (signal.sdp.type === 'offer') {
                        peer.createAnswer().then(answer => {
                            peer.setLocalDescription(answer);
                            this.socket.emit('returning_signal', {
                                signal: { type: 'sdp', sdp: answer }, callerID: callerID
                            });
                        });
                    }
                    while (item.candidateQueue.length > 0) {
                        const c = item.candidateQueue.shift();
                        peer.addIceCandidate(new RTCIceCandidate(c)).catch(e => console.error(e));
                    }
                });
            } 
            else if (signal.type === 'candidate') {
                if (peer.remoteDescription) {
                    peer.addIceCandidate(new RTCIceCandidate(signal.candidate)).catch(e => console.error(e));
                } else {
                    console.log("Queueing candidate for", callerID);
                    item.candidateQueue.push(signal.candidate);
                }
            }
        },

        handleRemoteStream: function(id, stream) {
            let videoEl = document.getElementById(`remote-${id}`);
            if (!videoEl) {
                const card = document.createElement('div');
                card.className = 'video-card'; card.id = `card-${id}`;
                
                videoEl = document.createElement('video');
                videoEl.id = `remote-${id}`;
                videoEl.className = 'video-content';
                videoEl.autoplay = true;
                videoEl.playsInline = true;
                videoEl.muted = false;

                const label = document.createElement('div');
                label.className = 'video-label';
                label.innerText = `REMOTE ${id.substr(0,4)}`;

                card.appendChild(videoEl); card.appendChild(label);
                this.videoGrid.appendChild(card);
            }
            videoEl.srcObject = stream;
        },

        toggleCamera: async function() {
            if (!this.isCameraOn) {
                try {
                    const videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 320, height: 240, facingMode: this.currentFacingMode }
                    });
                    const videoTrack = videoStream.getVideoTracks()[0];

                    this.localVideo.srcObject = videoStream;
                    this.localVideo.style.display = 'block';
                    this.videoPlaceholder.style.display = 'none';

                    for (let id in this.peers) {
                        const peer = this.peers[id].conn;
                        const sender = peer.getSenders().find(s => s.track && s.track.kind === 'video') 
                                    || peer.getSenders().find(s => s.track === null);
                        if (sender) sender.replaceTrack(videoTrack);
                    }

                    this.isCameraOn = true;
                    this.updateCamBtn(true);
                    videoTrack.onended = () => this.stopCamera();

                } catch (e) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: " + e.message); }
            } else {
                this.stopCamera();
            }
        },

        stopCamera: function() {
            if (this.localVideo.srcObject) {
                this.localVideo.srcObject.getTracks().forEach(t => t.stop());
            }
            for (let id in this.peers) {
                const peer = this.peers[id].conn;
                const sender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender) sender.replaceTrack(null);
            }
            this.localVideo.style.display = 'none';
            this.videoPlaceholder.style.display = 'flex';
            this.isCameraOn = false;
            this.updateCamBtn(false);
        },

        switchCamera: function() {
            if (!this.isCameraOn) return;
            this.currentFacingMode = (this.currentFacingMode === 'environment') ? 'user' : 'environment';
            this.stopCamera(); setTimeout(() => this.toggleCamera(), 300);
        },

        updateCamBtn: function(isOn) {
            const btn = document.getElementById('btn-toggle-cam');
            const switchBtn = document.getElementById('btn-switch-cam');
            if(isOn) {
                btn.innerText = "ðŸ“· CAM OFF"; btn.classList.add('active'); switchBtn.style.display = 'inline-block';
            } else {
                btn.innerText = "ðŸ“· CAM ON"; btn.classList.remove('active'); switchBtn.style.display = 'none';
            }
        },

        bindSocketEvents: function() {
            const s = this.socket;
            s.on('room_created', ({ roomId, hostToken }) => this.enterRoom(roomId, hostToken, true));
            
            s.on('joined_success', ({ roomId, isHost, usersToConnect }) => {
                this.enterRoom(roomId, null, isHost);
                usersToConnect.forEach(id => this.callPeer(id));
            });

            s.on('user_joined_signal', (p) => this.handleSignal(p));
            s.on('receiving_returned_signal', (p) => this.handleSignal(p));

            s.on('user_left', (id) => {
                if (this.peers[id]) { this.peers[id].conn.close(); delete this.peers[id]; }
                const el = document.getElementById(`card-${id}`); if(el) el.remove();
            });
            
            s.on('update_user_count', (c) => {
                const b = document.getElementById('user-count-display');
                b.style.display = 'block'; b.innerText = `ONLINE: ${c}`;
            });

            s.on('channel_busy', (id) => {
                if (id === this.socket.id) return;
                this.isChannelBusy = true;
                this.pttBtn.disabled = true; this.pttBtn.innerText = "RECEIVING...";
                this.statusText.innerText = "â— INCOMING SIGNAL"; this.statusText.style.color = "#198754";
                this.ledRx.classList.add('active');
            });
            s.on('channel_free', () => {
                this.isChannelBusy = false;
                this.pttBtn.disabled = false; this.pttBtn.innerText = "HOLD TO TALK";
                this.statusText.innerText = "CHANNEL READY"; this.statusText.style.color = "#6c757d";
                this.ledRx.classList.remove('active');
            });
            s.on('room_destroyed', () => { alert('HOST DESTROYED CHANNEL'); this.leaveRoom(); });
        },

        bindPTTLogic: function() {
            const startTalk = (e) => {
                if(e.cancelable) e.preventDefault();
                if (this.isChannelBusy || !this.localStream) return;
                this.isTalking = true;
                this.localStream.getAudioTracks()[0].enabled = true;
                this.socket.emit('start_talking', localStorage.getItem('ny_room_id'));
                this.updatePTTUI(true);
            };
            const stopTalk = (e) => {
                if(e.cancelable) e.preventDefault();
                if (!this.isTalking) return;
                this.isTalking = false;
                this.localStream.getAudioTracks()[0].enabled = false;
                this.socket.emit('stop_talking', localStorage.getItem('ny_room_id'));
                this.updatePTTUI(false);
            };
            this.pttBtn.addEventListener('mousedown', startTalk); window.addEventListener('mouseup', stopTalk);
            this.pttBtn.addEventListener('touchstart', startTalk, { passive: false }); this.pttBtn.addEventListener('touchend', stopTalk, { passive: false });
        },
        updatePTTUI: function(isTx) {
            if(isTx) {
                this.pttBtn.classList.add('active'); this.pttBtn.innerText = "TRANSMITTING";
                this.statusText.innerText = "â— ON AIR"; this.statusText.style.color = "#dc3545";
                this.ledTx.classList.add('active');
            } else {
                this.pttBtn.classList.remove('active'); this.pttBtn.innerText = "HOLD TO TALK";
                this.statusText.innerText = "CHANNEL READY"; this.statusText.style.color = "#6c757d";
                this.ledTx.classList.remove('active');
            }
        },
        createRoom: function() { this.socket.emit('create_room'); },
        enterRoom: function(id, token, isHost) {
            if(token) localStorage.setItem('ny_host_token', token);
            localStorage.setItem('ny_room_id', id);
            document.getElementById('lobby-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'flex';
            document.getElementById('room-id-display').innerText = id;
            this.p2pStatus.style.display = "inline-block";
            if(isHost) document.getElementById('host-destroy-btn').style.display = 'block';
        },
        leaveRoom: function() { location.reload(); },
        destroyRoom: function() { if(confirm('Destroy?')) this.socket.emit('destroy_room', { roomId: localStorage.getItem('ny_room_id'), token: localStorage.getItem('ny_host_token') }); },
        checkAutoLogin: function() {
            const id = localStorage.getItem('ny_room_id');
            if(id) document.getElementById('room-code-input').value = id;
        }
    };
    window.onload = () => App.init();
</script>
</body>
</html>